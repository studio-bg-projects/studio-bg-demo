<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="img/kite_fav.png">

  <title>Ambulance</title>

  <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,700&amp;subset=cyrillic" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/style.css" rel="stylesheet">

  <!-- JS -->
  <script src="js/lib/jquery.min.js"></script>
  <script src="js/lib/popper.min.js"></script>
  <script src="js/lib/bootstrap.min.js"></script>

  <script src="js/app/app.js"></script>
  <script src="js/app/load-config.js"></script>
  <script src="js/app/myMap.js"></script>
</head>

<body>

<header>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="index.html">
      <img src="img/logo_icn.png" alt="Atlantify"/>
      Atlantify
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
  </nav>
</header>

<!-- Begin page content -->
<main role="main" class="container">
  <ul class="breadcrumb">
    <li>
      <a href="index.html">Начало</a>
    </li>
    <li>
      <a href="index.html">Приложения</a>
    </li>
    <li>
      <span>Инструменти</span>
    </li>
  </ul>
  <div class="head">
    <h2>Инструменти</h2>
  </div>

  <h1>Пакети</h1>
  <p>Списък на пакетите с GPS данни, изпратени от линейките. Можете да търсите, подреждате, променяте и изтривате данни.</p>

  <div class="mt-5">
    <div class="row">
      <div class="col-md-9">
        <div class="table-control">
          <div class="row">
            <div class="col-md-4">
              <input type="text" placeholder="Търсене.." id="filter"/>
            </div>
            <div class="col-md-4">
              <div class="btn-holder" style="display: none;">
                <button class="btn btn-secondary" type="button">
                  Изтрий
                </button>
              </div>
            </div>
          </div>
        </div><!-- end table-control -->
        <table class="table table-hover">
          <colgroup>
            <col style="width: 6%">
            <col style="width: 30%">
            <col style="width: 34%">
            <col style="width: 15%">
            <col style="width: 15%">
          </colgroup>
          <thead>
          <tr>
            <!--
            <th scope="col"><input type="checkbox" name="checks" class="select-all"/></th>
            -->
            <th scope="col">Пакет</th>
            <th scope="col">Линейка Номер</th>
            <th scope="col">Размер</th>
            <th scope="col">Дата</th>
          </tr>
          </thead>
          <tbody id="listRows">
          <tr id="templateList">
            <!--
            <td><input type="checkbox" name="checks" class="checkbox"/></td>
            -->
            <td>#{{id}}</td>
            <td>{{plate}}</td>
            <td class="text-muted">{{size}}</td>
            <td class="text-muted">{{date}}</td>
          </tr>
          </tbody>
        </table>
      </div><!-- end col -->
      <div class="col-md-3">
        <div class="side-nav">
          <h4>Пакети</h4>
          <p>
            <button class="btn btn-light" type="button" data-toggle="collapse">
              <i class="material-icons">arrow_drop_down</i>
            </button>

            <a href="javascript:GpsList.showAllGroups();">
              <span id="groupCount">-</span>
              Всички линейки
            </a>
          </p>
          <div class="collapse show">
            <ul>
              <li id="templateGroups">
                <a href="javascript:;">
                  <span>{{count}}</span>
                  {{plate}}
                </a>
              </li>
            </ul>
          </div>
        </div><!-- end side nav -->
      </div><!-- end col -->
    </div><!-- end row -->
  </div>
</main>

<script>
  let GpsList = {};

  GpsList.init = function () {
    GpsList.initCheckbox();
    GpsList.createList();
    GpsList.createGroups();

    $('#filter').keyup(GpsList.filter);
  };

  GpsList.initCheckbox = function () {
    $('.select-all').change(function () {
      if (this.checked) {
        $('.checkbox').prop('checked', true);
        $('.btn-holder').show();
      } else {
        $('.checkbox').prop('checked', false);
        $('.btn-holder').hide();
      }
    });
    $('.checkbox').change(function () {
      if (this.checked) {
        $('.btn-holder').show();
      } else {
        $('.btn-holder').hide();
      }
    });
  };

  GpsList.createList = function () {
    let templateList = $('#templateList');

    $.each(Config.get('gpsList'), function (key) {
      let newList = templateList.clone();
      let newListHtml = newList.html();

      newListHtml = newListHtml.replace(/{{id}}/gi, this.id);
      newListHtml = newListHtml.replace(/{{plate}}/gi, this.plate);
      newListHtml = newListHtml.replace(/{{size}}/gi, this.size);
      newListHtml = newListHtml.replace(/{{date}}/gi, this.date);

      newList.html(newListHtml);
      newList.removeAttr('id');
      newList.click(function () {
        GpsList.showDetails(key);
      });

      newList.appendTo(templateList.parent());
    });

    templateList.remove();
  };

  GpsList.createGroups = function () {
    let templateGroups = $('#templateGroups');
    let groups = {};

    $.each(Config.get('gpsList'), function () {
      this.count = groups[this.plate] ? groups[this.plate].count + 1 : 1;
      groups[this.plate] = this;
    });

    $.each(groups, function () {
      let newList = templateGroups.clone();
      let newListHtml = newList.html();

      newListHtml = newListHtml.replace(/{{count}}/gi, this.count);
      newListHtml = newListHtml.replace(/{{plate}}/gi, this.plate);

      newList.html(newListHtml);
      newList.removeAttr('id');
      newList.click(function () {
        GpsList.showGroup(this.plate);
      }.bind(this));

      newList.appendTo(templateGroups.parent());
    });

    templateGroups.remove();

    // Set groups count
    $('#groupCount').html(Object.keys(groups).length);
  };

  GpsList.showDetails = function (key) {
    document.location = 'gps-snap.html?key=' + key;
  };

  GpsList.showGroup = function (plate) {
    $('#filter').val(plate);
    GpsList.filter();
  };

  GpsList.showAllGroups = function () {
    $('#filter').val('');
    GpsList.filter();
  };

  GpsList.filter = function () {
    let searchText = jQuery.trim($('#filter').val());
    let listRows = $('#listRows tr');

    if (!searchText) {
      listRows.fadeIn();
      return;
    }

    listRows.each(function () {
      let rowText = '';
      $(this).find('td').each(function () {
        rowText += ' ' + $(this).text();
      });

      if (rowText.search(searchText) === -1) {
        $(this).hide();
      } else {
        $(this).fadeIn();
      }
    });
  };

  App.ready(GpsList.init);
</script>
</body>
</html>
